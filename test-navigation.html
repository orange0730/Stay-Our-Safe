<!DOCTYPE html>
<html>
<head>
    <title>å°èˆªå’Œ API å…¨é¢æ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-section { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; border-left: 4px solid; }
        .success { background-color: #d4edda; border-color: #28a745; color: #155724; }
        .error { background-color: #f8d7da; border-color: #dc3545; color: #721c24; }
        .warning { background-color: #fff3cd; border-color: #ffc107; color: #856404; }
        button { padding: 12px 24px; margin: 8px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .status { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status.online { background: #28a745; }
        .status.offline { background: #dc3545; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .progress { width: 100%; background: #e9ecef; border-radius: 4px; overflow: hidden; margin: 10px 0; }
        .progress-bar { height: 20px; background: #007bff; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Stay Our Safe - å®Œæ•´åŠŸèƒ½æ¸¬è©¦</h1>
        <p>æœ€å¾Œæ›´æ–°: <span id="last-update"></span></p>
        
        <!-- æœå‹™ç‹€æ…‹æ¦‚è¦½ -->
        <div class="test-section">
            <h2>ğŸ“Š æœå‹™ç‹€æ…‹æ¦‚è¦½</h2>
            <div class="grid">
                <div>
                    <h3>å¾Œç«¯æœå‹™ (Port 3001)</h3>
                    <div id="backend-status">æª¢æŸ¥ä¸­...</div>
                </div>
                <div>
                    <h3>å‰ç«¯æœå‹™ (Port 3000)</h3>
                    <div id="frontend-status">æª¢æŸ¥ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- API æ¸¬è©¦ -->
        <div class="test-section">
            <h2>ğŸŒ API ç«¯é»æ¸¬è©¦</h2>
            <div style="margin: 20px 0;">
                <button onclick="testAllApis()">ğŸ”„ æ¸¬è©¦æ‰€æœ‰ API</button>
                <button onclick="testHazards()">âš ï¸ ç½å®³ API</button>
                <button onclick="testAlerts()">ğŸš¨ è­¦å ± API</button>
                <button onclick="testNavigation()">ğŸ—ºï¸ å°èˆª API</button>
                <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤çµæœ</button>
            </div>
            <div class="progress">
                <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
            </div>
            <div id="api-results"></div>
        </div>

        <!-- å°èˆªæ¸¬è©¦ -->
        <div class="test-section">
            <h2>ğŸ§­ å°èˆªåŠŸèƒ½æ¸¬è©¦</h2>
            <div class="grid">
                <div>
                    <h4>æ¸¬è©¦è·¯ç·š</h4>
                    <button onclick="testRouteCalculation()">è¨ˆç®—æ¸¬è©¦è·¯ç·š</button>
                    <button onclick="testAddressSearch()">æ¸¬è©¦åœ°å€æœç´¢</button>
                    <div id="navigation-results"></div>
                </div>
                <div>
                    <h4>è·¯ç·šè³‡è¨Š</h4>
                    <div id="route-info">å°šæœªè¨ˆç®—è·¯ç·š</div>
                </div>
            </div>
        </div>

        <!-- å³æ™‚ç›£æ§ -->
        <div class="test-section">
            <h2>ğŸ“ˆ å³æ™‚ç›£æ§</h2>
            <button onclick="toggleMonitoring()" id="monitor-btn">é–‹å§‹ç›£æ§</button>
            <div id="monitoring-data"></div>
        </div>

        <!-- è©³ç´°æ—¥èªŒ */
        <div class="test-section">
            <h2>ğŸ“‹ è©³ç´°æ—¥èªŒ</h2>
            <div id="detailed-logs" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        const FRONTEND_URL = 'http://localhost:3000';
        let isMonitoring = false;
        let monitoringInterval = null;
        
        // æ›´æ–°æ™‚é–“
        document.getElementById('last-update').textContent = new Date().toLocaleString();
        
        function addResult(message, type = 'success', target = 'api-results') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            div.innerHTML = `<strong>${timestamp}</strong>: ${message}`;
            document.getElementById(target).appendChild(div);
            
            // åŒæ™‚æ·»åŠ åˆ°è©³ç´°æ—¥èªŒ
            addToLog(`[${type.toUpperCase()}] ${message}`);
        }
        
        function addToLog(message) {
            const logDiv = document.getElementById('detailed-logs');
            const timestamp = new Date().toISOString();
            logDiv.innerHTML += `${timestamp}: ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateProgress(percentage) {
            document.getElementById('progress-bar').style.width = `${percentage}%`;
        }
        
        function updateStatus(service, isOnline) {
            const statusEl = document.getElementById(`${service}-status`);
            const statusClass = isOnline ? 'online' : 'offline';
            const statusText = isOnline ? 'æ­£å¸¸é‹è¡Œ' : 'ç„¡æ³•é€£æ¥';
            statusEl.innerHTML = `<span class="status ${statusClass}"></span>${statusText}`;
        }
        
        async function testBackend() {
            try {
                addToLog('æ¸¬è©¦å¾Œç«¯å¥åº·æª¢æŸ¥...');
                const response = await fetch(`${API_BASE}/../health`, { 
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    updateStatus('backend', true);
                    addResult(`âœ… å¾Œç«¯æœå‹™æ­£å¸¸ (æ­£å¸¸é‹è¡Œæ™‚é–“: ${Math.round(data.uptime || 0)}ç§’)`);
                    return true;
                } else {
                    updateStatus('backend', false);
                    addResult(`âš ï¸ å¾Œç«¯éŸ¿æ‡‰ç•°å¸¸: ${response.status}`, 'warning');
                    return false;
                }
            } catch (error) {
                updateStatus('backend', false);
                addResult(`âŒ å¾Œç«¯é€£æ¥å¤±æ•—: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testFrontend() {
            try {
                const response = await fetch(FRONTEND_URL, { 
                    method: 'GET',
                    mode: 'no-cors'
                });
                updateStatus('frontend', true);
                addResult(`âœ… å‰ç«¯æœå‹™æ­£å¸¸`);
                return true;
            } catch (error) {
                updateStatus('frontend', false);
                addResult(`âŒ å‰ç«¯é€£æ¥å¤±æ•—`, 'error');
                return false;
            }
        }
        
        async function testHazards() {
            try {
                addResult('ğŸ” æ¸¬è©¦ç½å®³è³‡æ–™ API...', 'warning');
                const response = await fetch(`${API_BASE}/hazards`, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const count = data.data?.length || 0;
                    addResult(`âœ… ç½å®³ API æˆåŠŸï¼æ”¶åˆ° ${count} ç­†ç½å®³è³‡æ–™`);
                    if (count > 0) {
                        addResult(`ğŸ“Š ç½å®³é¡å‹: ${data.data.map(h => h.type).join(', ')}`);
                    }
                    return true;
                } else {
                    addResult(`âš ï¸ ç½å®³ API ç•°å¸¸: ${response.status}`, 'warning');
                    return false;
                }
            } catch (error) {
                addResult(`âŒ ç½å®³ API å¤±æ•—: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testAlerts() {
            try {
                addResult('ğŸ” æ¸¬è©¦è­¦å ±è³‡æ–™ API...', 'warning');
                const response = await fetch(`${API_BASE}/alerts/recent`, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const alertCount = data.data?.recentAlerts?.length || 0;
                    const assessmentCount = data.data?.recentAssessments?.length || 0;
                    addResult(`âœ… è­¦å ± API æˆåŠŸï¼æ”¶åˆ° ${alertCount} ç­†è­¦å ±ï¼Œ${assessmentCount} ç­†è©•ä¼°`);
                    
                    if (data.data?.summary) {
                        const summary = data.data.summary;
                        addResult(`ğŸ“ˆ çµ±è¨ˆ: ${summary.totalAlerts} ç¸½è­¦å ±ï¼Œ${summary.activeAlerts} é€²è¡Œä¸­ï¼Œ${summary.highSeverityAlerts} é«˜é¢¨éšª`);
                    }
                    return true;
                } else {
                    addResult(`âš ï¸ è­¦å ± API ç•°å¸¸: ${response.status}`, 'warning');
                    return false;
                }
            } catch (error) {
                addResult(`âŒ è­¦å ± API å¤±æ•—: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testNavigation() {
            try {
                addResult('ğŸ” æ¸¬è©¦å°èˆªè·¯ç·šè¦åŠƒ...', 'warning');
                
                const testRoute = {
                    start: { lat: 25.0330, lng: 121.5654 },  // å°åŒ—è»Šç«™
                    end: { lat: 25.0478, lng: 121.5173 },    // è¥¿é–€ç”º
                    preferSafety: true,
                    avoidHazardTypes: ['flood']
                };
                
                const response = await fetch(`${API_BASE}/map/route`, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testRoute)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addResult(`âœ… å°èˆª API æˆåŠŸï¼è·¯ç·šè¦åŠƒå®Œæˆ`);
                    
                    if (data.data?.safestRoute) {
                        const route = data.data.safestRoute;
                        const distance = (route.distance / 1000).toFixed(1);
                        const duration = Math.round(route.duration / 60);
                        addResult(`ğŸ—ºï¸ æœ€å®‰å…¨è·¯ç·š: ${distance}å…¬é‡Œï¼Œé ä¼°${duration}åˆ†é˜ï¼Œé¢¨éšªç­‰ç´š${route.riskLevel}/4`);
                        
                        // æ›´æ–°è·¯ç·šè³‡è¨Šé¡¯ç¤º
                        document.getElementById('route-info').innerHTML = `
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px;">
                                <strong>æ¸¬è©¦è·¯ç·š (å°åŒ—è»Šç«™ â†’ è¥¿é–€ç”º)</strong><br>
                                è·é›¢: ${distance} å…¬é‡Œ<br>
                                æ™‚é–“: ${duration} åˆ†é˜<br>
                                é¢¨éšª: ${route.riskLevel}/4<br>
                                è·¯é»: ${route.route?.length || 0} å€‹
                            </div>
                        `;
                    }
                    return true;
                } else {
                    addResult(`âš ï¸ å°èˆª API ç•°å¸¸: ${response.status}`, 'warning');
                    return false;
                }
            } catch (error) {
                addResult(`âŒ å°èˆª API å¤±æ•—: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testAddressSearch() {
            try {
                addResult('ğŸ” æ¸¬è©¦åœ°å€æœç´¢...', 'warning', 'navigation-results');
                
                // ä½¿ç”¨ OpenStreetMap Nominatim API æ¸¬è©¦
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent('å°åŒ—è»Šç«™')}&limit=3&countrycodes=tw`
                );
                
                if (response.ok) {
                    const data = await response.json();
                    addResult(`âœ… åœ°å€æœç´¢æˆåŠŸï¼æ‰¾åˆ° ${data.length} å€‹çµæœ`, 'success', 'navigation-results');
                    
                    if (data.length > 0) {
                        addResult(`ğŸ“ ç¬¬ä¸€å€‹çµæœ: ${data[0].display_name}`, 'success', 'navigation-results');
                    }
                    return true;
                } else {
                    addResult(`âš ï¸ åœ°å€æœç´¢å¤±æ•—: ${response.status}`, 'warning', 'navigation-results');
                    return false;
                }
            } catch (error) {
                addResult(`âŒ åœ°å€æœç´¢éŒ¯èª¤: ${error.message}`, 'error', 'navigation-results');
                return false;
            }
        }
        
        async function testRouteCalculation() {
            addResult('ğŸ§® æ¨¡æ“¬å‰ç«¯è·¯ç·šè¨ˆç®—...', 'warning', 'navigation-results');
            
            // æ¨¡æ“¬å‰ç«¯çš„è·¯ç·šè¨ˆç®—é‚è¼¯
            const start = { lat: 25.0330, lng: 121.5654 };
            const end = { lat: 25.0478, lng: 121.5173 };
            
            // è¨ˆç®—ç›´ç·šè·é›¢
            const distance = Math.sqrt(
                Math.pow(end.lat - start.lat, 2) + 
                Math.pow(end.lng - start.lng, 2)
            ) * 111000;
            
            addResult(`ğŸ“ ç›´ç·šè·é›¢ç´„ ${(distance / 1000).toFixed(1)} å…¬é‡Œ`, 'success', 'navigation-results');
            addResult(`â±ï¸ é ä¼°æ­¥è¡Œæ™‚é–“ç´„ ${Math.round(distance / 80)} åˆ†é˜`, 'success', 'navigation-results');
            
            // æ¸¬è©¦è·¯é»ç”Ÿæˆ
            const routePoints = [];
            const steps = 10;
            for (let i = 0; i <= steps; i++) {
                routePoints.push({
                    lat: start.lat + (end.lat - start.lat) * (i / steps),
                    lng: start.lng + (end.lng - start.lng) * (i / steps)
                });
            }
            
            addResult(`ğŸ—ºï¸ ç”Ÿæˆ ${routePoints.length} å€‹è·¯é»`, 'success', 'navigation-results');
        }
        
        async function testAllApis() {
            addResult('ğŸš€ é–‹å§‹å®Œæ•´ API æ¸¬è©¦...', 'warning');
            clearResults();
            updateProgress(0);
            
            const tests = [
                { name: 'å¾Œç«¯æœå‹™', fn: testBackend },
                { name: 'å‰ç«¯æœå‹™', fn: testFrontend },
                { name: 'ç½å®³è³‡æ–™', fn: testHazards },
                { name: 'è­¦å ±è³‡æ–™', fn: testAlerts },
                { name: 'å°èˆªåŠŸèƒ½', fn: testNavigation }
            ];
            
            let completed = 0;
            for (const test of tests) {
                try {
                    addResult(`ğŸ”„ æ¸¬è©¦ ${test.name}...`, 'warning');
                    await test.fn();
                    completed++;
                    updateProgress((completed / tests.length) * 100);
                    await new Promise(resolve => setTimeout(resolve, 500));
                } catch (error) {
                    addResult(`âŒ ${test.name} æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                }
            }
            
            addResult(`âœ¨ æ¸¬è©¦å®Œæˆï¼å®Œæˆ ${completed}/${tests.length} é …æ¸¬è©¦`, completed === tests.length ? 'success' : 'warning');
        }
        
        function toggleMonitoring() {
            const btn = document.getElementById('monitor-btn');
            
            if (isMonitoring) {
                clearInterval(monitoringInterval);
                isMonitoring = false;
                btn.textContent = 'é–‹å§‹ç›£æ§';
                btn.style.background = '#007bff';
            } else {
                isMonitoring = true;
                btn.textContent = 'åœæ­¢ç›£æ§';
                btn.style.background = '#dc3545';
                
                monitoringInterval = setInterval(async () => {
                    const monitoringDiv = document.getElementById('monitoring-data');
                    const timestamp = new Date().toLocaleTimeString();
                    
                    try {
                        // å¿«é€Ÿæª¢æŸ¥å¾Œç«¯ç‹€æ…‹
                        const response = await fetch(`${API_BASE}/../health`, { 
                            method: 'GET',
                            mode: 'cors',
                            cache: 'no-cache'
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            monitoringDiv.innerHTML = `
                                <div style="background: #d4edda; padding: 10px; border-radius: 4px; margin: 5px 0;">
                                    <strong>${timestamp}</strong> - âœ… å¾Œç«¯æ­£å¸¸ (æ­£å¸¸é‹è¡Œ: ${Math.round(data.uptime || 0)}ç§’)
                                </div>
                            ` + (monitoringDiv.innerHTML || '');
                        } else {
                            monitoringDiv.innerHTML = `
                                <div style="background: #f8d7da; padding: 10px; border-radius: 4px; margin: 5px 0;">
                                    <strong>${timestamp}</strong> - âŒ å¾Œç«¯ç•°å¸¸ (${response.status})
                                </div>
                            ` + (monitoringDiv.innerHTML || '');
                        }
                    } catch (error) {
                        monitoringDiv.innerHTML = `
                            <div style="background: #f8d7da; padding: 10px; border-radius: 4px; margin: 5px 0;">
                                <strong>${timestamp}</strong> - âŒ é€£æ¥å¤±æ•—
                            </div>
                        ` + (monitoringDiv.innerHTML || '');
                    }
                    
                    // é™åˆ¶ç›£æ§è¨˜éŒ„æ•¸é‡
                    const records = monitoringDiv.children;
                    if (records.length > 10) {
                        monitoringDiv.removeChild(records[records.length - 1]);
                    }
                }, 5000);
            }
        }
        
        function clearResults() {
            document.getElementById('api-results').innerHTML = '';
            document.getElementById('navigation-results').innerHTML = '';
            updateProgress(0);
        }
        
        // è‡ªå‹•åˆå§‹åŒ–
        window.onload = () => {
            addToLog('æ¸¬è©¦é é¢åˆå§‹åŒ–å®Œæˆ');
            setTimeout(() => {
                testBackend();
                testFrontend();
            }, 1000);
        };
    </script>
</body>
</html> 